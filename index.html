<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>專業眼鏡量度系統 V8.7</title>
    <!-- 引入外部庫 -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #000; color: #fff; margin: 0; overflow: hidden; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        input[type=range] { -webkit-appearance: none; background: transparent; cursor: pointer; width: 100%; }
        input[type=range]::-webkit-slider-runnable-track { height: 2px; background: rgba(255,255,255,0.15); border-radius: 10px; }
        input[type=range]::-webkit-slider-thumb { 
            -webkit-appearance: none; height: 24px; width: 24px; border-radius: 50%; 
            background: #3b82f6; border: 3px solid #fff; margin-top: -11px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.5); 
        }

        .shutter-ring { border: 4px solid rgba(255,255,255,0.2); transition: all 0.2s; }
        .is-level { border-color: #22c55e !important; box-shadow: 0 0 35px rgba(34, 197, 94, 0.4); }
        .btn-active:active { transform: scale(0.92); }
        
        /* 防止 iPad 長按彈出選單 */
        * { -webkit-touch-callout: none !important; -webkit-user-select: none !important; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/javascript">
        const { useState, useRef, useEffect, useCallback } = React;

        const App = () => {
            // --- 狀態定義 ---
            const [photos, setPhotos] = useState([]);
            const [viewingPhoto, setViewingPhoto] = useState(null);
            
            // 影像調節
            const [brightness, setBrightness] = useState(100);
            const [contrast, setContrast] = useState(100);
            const [hue, setHue] = useState(0);
            const [isMirrored, setIsMirrored] = useState(true);
            const [showGuide, setShowGuide] = useState(true);
            const [facingMode, setFacingMode] = useState('user');

            // 系統與姿態
            const [isStarted, setIsStarted] = useState(false);
            const [pitch, setPitch] = useState(0);
            const [roll, setRoll] = useState(0);
            const [isLevel, setIsLevel] = useState(false);

            // 量度標定
            const [points, setPoints] = useState([]);
            const [crosshair, setCrosshair] = useState(null);

            const videoRef = useRef(null);
            const imgRef = useRef(null);

            // 每輪渲染後更新 Lucide 圖標
            useEffect(() => { 
                if (window.lucide) window.lucide.createIcons(); 
            });

            // 姿態處理邏輯 (iPad 橫放優化：鏡頭在上)
            const handleOrientation = useCallback((e) => {
                const b = e.beta;  // 前後傾斜 (理想 90)
                const g = e.gamma; // 左右水平 (理想 0)
                setPitch(b);
                setRoll(g);
                // 規則：垂直於地面 90° ±3°，左右水平 0° ±3°
                setIsLevel(Math.abs(b - 90) <= 3 && Math.abs(g) <= 3);
            }, []);

            // 核心啟動：符合 iOS 安全政策的用戶點擊觸發
            const startSystem = async () => {
                try {
                    // 1. 請求相機
                    const stream = await navigator.mediaDevices.getUserMedia({
                        video: { facingMode, width: { ideal: 1920 }, height: { ideal: 1080 } },
                        audio: false
                    });
                    if (videoRef.current) videoRef.current.srcObject = stream;

                    // 2. 請求陀螺儀 (iOS 13+ 必須主動請求)
                    if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                        const permission = await DeviceOrientationEvent.requestPermission();
                        if (permission === 'granted') {
                            window.addEventListener('deviceorientation', handleOrientation, true);
                        }
                    } else {
                        window.addEventListener('deviceorientation', handleOrientation, true);
                    }

                    setIsStarted(true);
                } catch (err) {
                    alert("啟動失敗：請確保在 HTTPS 環境下並授予相機及感應器權限。");
                    console.error(err);
                }
            };

            // 拍照並擷取目前濾鏡效果
            const takePhoto = () => {
                if (!videoRef.current) return;
                const video = videoRef.current;
                const canvas = document.createElement('canvas');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                const ctx = canvas.getContext('2d');
                
                // 套用濾鏡
                ctx.filter = `brightness(${brightness}%) contrast(${contrast}%) hue-rotate(${hue}deg)`;
                
                if (isMirrored) {
                    ctx.translate(canvas.width, 0);
                    ctx.scale(-1, 1);
                }
                
                ctx.drawImage(video, 0, 0);
                const dataUrl = canvas.toDataURL('image/jpeg', 0.95);
                setPhotos(prev => [{ id: Date.now(), url: dataUrl }, ...prev]);
            };

            // 儲存至相簿 (下載檔案)
            const downloadPhoto = () => {
                if (!viewingPhoto) return;
                const link = document.createElement('a');
                link.href = viewingPhoto.url;
                link.download = `MEASURE_RESULT_${Date.now()}.jpg`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                // iPad 上通常會提示下載，完成後可存入相簿
            };

            return React.createElement('div', { className: "flex flex-col h-screen w-screen bg-black" },
                
                // --- 頂部：相機與工作區 (65%) ---
                React.createElement('div', { className: "relative h-[65%] w-full bg-zinc-950 flex items-center justify-center border-b border-white/5 overflow-hidden" },
                    !isStarted ? 
                    // 初始啟動按鈕
                    React.createElement('button', { 
                        onClick: startSystem,
                        className: "z-50 bg-blue-600 px-14 py-7 rounded-[2.5rem] font-black text-xl flex items-center gap-4 shadow-2xl btn-active"
                    }, React.createElement('i', { 'data-lucide': "camera" }), "啟動量度系統") :
                    
                    (viewingPhoto ? 
                        // 查看/標定照片模式
                        React.createElement('div', { className: "relative w-full h-full flex items-center justify-center bg-black" },
                            React.createElement('img', { 
                                ref: imgRef, src: viewingPhoto.url, 
                                className: "max-h-full max-w-full shadow-2xl",
                                onClick: (e) => {
                                    const rect = e.target.getBoundingClientRect();
                                    const x = ((e.clientX - rect.left) / rect.width) * 1920; 
                                    const y = ((e.clientY - rect.top) / rect.height) * 1080;
                                    setCrosshair({x, y});
                                }
                            }),
                            React.createElement('button', { 
                                onClick: () => { setViewingPhoto(null); setPoints([]); setCrosshair(null); },
                                className: "absolute top-6 left-6 p-4 bg-white/10 rounded-full border border-white/10 btn-active"
                            }, React.createElement('i', { 'data-lucide': "x" })),
                            
                            // 標定確認工具
                            React.createElement('div', { className: "absolute bottom-10 right-10 flex flex-col gap-4" },
                                React.createElement('button', { 
                                    onClick: () => { if(crosshair) { setPoints([...points, crosshair]); setCrosshair(null); }},
                                    className: "w-20 h-20 bg-blue-600 rounded-full flex items-center justify-center shadow-xl btn-active"
                                }, React.createElement('i', { 'data-lucide': "check", className: "w-10 h-10" })),
                                React.createElement('button', { 
                                    onClick: () => { setPoints([]); setCrosshair(null); },
                                    className: "w-14 h-14 bg-zinc-800 rounded-full flex items-center justify-center"
                                }, React.createElement('i', { 'data-lucide': "rotate-ccw" }))
                            ),
                            // 標定點渲染
                            points.map((p, i) => React.createElement('div', {
                                key: i,
                                className: "absolute w-4 h-4 bg-blue-500 rounded-full border-2 border-white -translate-x-1/2 -translate-y-1/2 shadow-xl",
                                style: { left: `${(p.x/1920)*100}%`, top: `${(p.y/1080)*100}%` }
                            }))
                        ) : 
                        // 實時攝影模式
                        React.createElement('div', { className: "relative w-full h-full" },
                            React.createElement('video', { 
                                ref: videoRef, autoPlay: true, playsInline: true, 
                                className: `w-full h-full object-cover ${isMirrored ? 'scale-x-[-1]' : ''}`,
                                style: { filter: `brightness(${brightness}%) contrast(${contrast}%) hue-rotate(${hue}deg)` }
                            }),
                            
                            // 姿態指示器與水平輔助線
                            React.createElement('div', { className: `absolute inset-0 pointer-events-none border-[12px] transition-all duration-300 ${isLevel ? 'border-green-500/20' : 'border-red-500/10'}` },
                                React.createElement('div', { className: "absolute inset-0 flex items-center justify-center" },
                                    React.createElement('div', { className: `w-36 h-36 border-2 rounded-full flex items-center justify-center transition-all ${isLevel ? 'border-green-400 scale-105 shadow-[0_0_50px_rgba(34,197,94,0.3)]' : 'border-white/10'}` },
                                        React.createElement('div', { className: `w-2 h-2 rounded-full ${isLevel ? 'bg-green-400' : 'bg-white/20'}` })
                                    )
                                ),
                                // 左下角數據
                                React.createElement('div', { className: "absolute bottom-10 left-10 flex gap-4" },
                                    React.createElement('div', { className: `px-6 py-3 rounded-2xl backdrop-blur-xl border ${Math.abs(pitch-90)<=3 ? 'bg-green-600/40 border-green-500' : 'bg-zinc-900/90 border-white/10 text-white/50'}` },
                                        React.createElement('div', { className: "text-[10px] font-black uppercase" }, "Pitch 垂直度"),
                                        React.createElement('div', { className: "text-xl font-mono font-bold" }, `${pitch.toFixed(1)}°`)
                                    ),
                                    React.createElement('div', { className: `px-6 py-3 rounded-2xl backdrop-blur-xl border ${Math.abs(roll)<=3 ? 'bg-green-600/40 border-green-500' : 'bg-zinc-900/90 border-white/10 text-white/50'}` },
                                        React.createElement('div', { className: "text-[10px] font-black uppercase" }, "Roll 水平度"),
                                        React.createElement('div', { className: "text-xl font-mono font-bold" }, `${roll.toFixed(1)}°`)
                                    )
                                )
                            ),

                            // 右側功能按鈕 (切換, 鏡像, 網格)
                            React.createElement('div', { className: "absolute top-6 right-6 flex flex-col gap-3 bg-black/40 p-2 rounded-3xl border border-white/10 backdrop-blur-md" },
                                React.createElement('button', { onClick: () => setFacingMode(f => f==='user'?'environment':'user'), className: "w-14 h-14 flex items-center justify-center btn-active" }, React.createElement('i', { 'data-lucide': "refresh-cw" })),
                                React.createElement('button', { onClick: () => setIsMirrored(!isMirrored), className: `w-14 h-14 rounded-2xl flex items-center justify-center ${isMirrored ? 'bg-blue-600 shadow-lg' : 'text-gray-400'}` }, React.createElement('i', { 'data-lucide': "flip-horizontal" })),
                                React.createElement('button', { onClick: () => setShowGuide(!showGuide), className: `w-14 h-14 rounded-2xl flex items-center justify-center ${showGuide ? 'bg-blue-600 shadow-lg' : 'text-gray-400'}` }, React.createElement('i', { 'data-lucide': "grid-3x3" }))
                            ),

                            // --- 右側拇指快門按鈕 ---
                            React.createElement('div', { className: "absolute right-12 top-1/2 -translate-y-1/2" },
                                React.createElement('button', { 
                                    onClick: takePhoto,
                                    className: `shutter-ring w-28 h-28 rounded-full p-2.5 flex items-center justify-center btn-active ${isLevel ? 'is-level' : 'opacity-30'}`
                                }, React.createElement('div', { className: `w-full h-full rounded-full ${isLevel ? 'bg-white shadow-2xl' : 'bg-zinc-700'}` }))
                            )
                        )
                    )
                ),

                // --- 下半部：相簿與調節工具 (35%) ---
                React.createElement('div', { className: "h-[35%] w-full bg-[#080808] p-6 flex gap-6" },
                    // 左側相簿 (60%)
                    React.createElement('div', { className: "w-[60%] flex flex-col gap-4" },
                        React.createElement('h3', { className: "text-[10px] font-black text-gray-500 uppercase tracking-widest px-1" }, "量度相簿庫"),
                        React.createElement('div', { className: "flex-1 flex gap-4 overflow-x-auto no-scrollbar items-center px-1" },
                            photos.length === 0 ? 
                            React.createElement('div', { className: "w-full h-full border-2 border-dashed border-white/5 rounded-[2rem] flex items-center justify-center text-zinc-800 text-xs font-bold" }, "尚無照片") :
                            photos.map(p => React.createElement('div', { 
                                key: p.id, onClick: () => { setViewingPhoto(p); setPoints([]); setCrosshair(null); },
                                className: `flex-shrink-0 h-full aspect-[4/3] rounded-[1.5rem] overflow-hidden border-2 transition-all ${viewingPhoto?.id === p.id ? 'border-blue-500 shadow-2xl scale-95' : 'border-white/5 opacity-40'}` 
                            }, React.createElement('img', { src: p.url, className: "w-full h-full object-cover" })))
                        )
                    ),
                    
                    // 右側調節與儲存 (40%)
                    React.createElement('div', { className: "w-[40%] bg-white/[0.03] rounded-[2.5rem] border border-white/5 p-6 flex items-center gap-6 shadow-xl" },
                        // 滑桿列
                        React.createElement('div', { className: "flex-1 space-y-4" },
                            [['sun', brightness, setBrightness, 50, 150], ['contrast', contrast, setContrast, 50, 150], ['palette', hue, setHue, -45, 45]].map(([icon, val, set, min, max]) => 
                                React.createElement('div', { className: "flex items-center gap-4", key: icon },
                                    React.createElement('i', { 'data-lucide': icon, className: "text-zinc-500 w-5 h-5 flex-shrink-0" }),
                                    React.createElement('input', { type: "range", min: min, max: max, value: val, onChange: e => set(parseInt(e.target.value)) })
                                )
                            )
                        ),
                        // 儲存按鈕 (位於滑桿右側)
                        React.createElement('button', { 
                            onClick: downloadPhoto,
                            disabled: !viewingPhoto,
                            className: `w-24 h-24 rounded-[2rem] flex flex-col items-center justify-center gap-2 transition-all btn-active shadow-2xl ${viewingPhoto ? 'bg-blue-600 text-white' : 'bg-zinc-900 text-zinc-700'}`
                        }, 
                            React.createElement('i', { 'data-lucide': "download", className: "w-6 h-6" }),
                            React.createElement('span', { className: "text-[10px] font-black uppercase" }, "儲存相片")
                        )
                    )
                )
            );
        };

        // 渲染應用程式
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(React.createElement(App));
    </script>
</body>
</html>

